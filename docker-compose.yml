services:
  # -----------------------------------------
  # SQS LOCAL (ElasticMQ)
  # -----------------------------------------
  sqs-local:
    image: softwaremill/elasticmq-native:1.3.14
    container_name: sqs-local
    ports:
      - "9324:9324"
      - "9325:9325"
    volumes:
      - ./localstack/elasticmq.conf:/opt/elasticmq.conf
    environment:
      - JAVA_OPTS=-Dconfig.file=/opt/elasticmq.conf
    networks:
      - togglemaster

  # -----------------------------------------
  # DYNAMODB LOCAL
  # -----------------------------------------
  dynamodb-local:
    image: amazon/dynamodb-local
    container_name: dynamodb-local
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -inMemory -sharedDb"
    networks:
      - togglemaster

  # -----------------------------------------
  # AUTH DATABASE
  # -----------------------------------------
  auth-postgres:
    image: postgres:15
    container_name: auth-postgres
    restart: always
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: authdb
    ports:
      - "5433:5432"
    networks:
      - togglemaster

  # -----------------------------------------
  # AUTH SERVICE (Go)
  # -----------------------------------------
  auth-service:
    build:
      context: ./auth-service
    container_name: auth-service
    depends_on:
      - auth-postgres
    environment:
      PORT: 8001
      DATABASE_URL: postgres://admin:admin@auth-postgres:5432/authdb?sslmode=disable
    ports:
      - "8001:8001"
    networks:
      - togglemaster

  # -----------------------------------------
  # FLAG DATABASE
  # -----------------------------------------
  flag-postgres:
    image: postgres:15
    container_name: flag-postgres
    restart: always
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: flagdb
    ports:
      - "5434:5432"
    networks:
      - togglemaster

  # -----------------------------------------
  # FLAG SERVICE (Go)
  # -----------------------------------------
  flag-service:
    build:
      context: ./flag-service
    container_name: flag-service
    depends_on:
      - flag-postgres
    environment:
      PORT: 8002
      DATABASE_URL: postgres://admin:admin@flag-postgres:5432/flagdb?sslmode=disable
    ports:
      - "8002:8002"
    networks:
      - togglemaster

  # -----------------------------------------
  # TARGETING SERVICE (Go)
  # -----------------------------------------
  targeting-service:
    build:
      context: ./targeting-service
    container_name: targeting-service
    depends_on:
      - flag-service
    environment:
      PORT: 8003
      FLAG_SERVICE_URL: http://flag-service:8002
    ports:
      - "8003:8003"
    networks:
      - togglemaster

  # -----------------------------------------
  # EVALUATION SERVICE (Go)
  # -----------------------------------------
  evaluation-service:
    build:
      context: ./evaluation-service
    container_name: evaluation-service
    depends_on:
      - targeting-service
      - sqs-local
    environment:
      PORT: 8004
      TARGETING_SERVICE_URL: http://targeting-service:8003

      # Envio de eventos para o SQS local
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: dummy
      AWS_SECRET_ACCESS_KEY: dummy
      AWS_SESSION_TOKEN: dummy
      AWS_SQS_URL: http://sqs-local:9324/queue/togglemaster-events

    ports:
      - "8004:8004"
    networks:
      - togglemaster

  # -----------------------------------------
  # ANALYTICS SERVICE (Python)
  # -----------------------------------------
  analytics-service:
    build:
      context: ./analytics-service
    container_name: analytics-service
    depends_on:
      - sqs-local
      - dynamodb-local
    environment:
      PORT: 8006

      # Variáveis obrigatórias — agora completas
      AWS_SQS_URL: http://sqs-local:9324/queue/togglemaster-events
      AWS_REGION: us-east-1
      AWS_DYNAMODB_TABLE: ToggleMasterAnalytics

      # Credenciais dummy para funcionamento do boto3
      AWS_ACCESS_KEY_ID: dummy
      AWS_SECRET_ACCESS_KEY: dummy
      AWS_SESSION_TOKEN: dummy

      # Endpoint para acessar DynamoDB Local
      DYNAMODB_ENDPOINT: http://dynamodb-local:8000
    ports:
      - "8006:8006"
    networks:
      - togglemaster

networks:
  togglemaster:
    driver: bridge
