services:
  # -------------------------------------------------------------
  # PostgreSQL do AUTH-SERVICE
  # -------------------------------------------------------------
  auth-postgres:
    image: postgres:13
    container_name: auth-postgres
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_password
    volumes:
      - ./auth-service/db/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5433:5432"
    networks:
      - togglemaster

  # -------------------------------------------------------------
  # AUTH-SERVICE
  # -------------------------------------------------------------
  auth-service:
    build: ./auth-service
    container_name: auth-service
    depends_on:
      - auth-postgres
    environment:
      PORT: "8001"
      DATABASE_URL: "postgresql://auth_user:auth_password@auth-postgres:5432/auth_db"
      ADMIN_SECRET_KEY: "admin-secreto-123"
    ports:
      - "8001:8001"
    networks:
      - togglemaster

  # -------------------------------------------------------------
  # PostgreSQL do FLAG-SERVICE
  # -------------------------------------------------------------
  flag-postgres:
    image: postgres:13
    container_name: flag-postgres
    environment:
      POSTGRES_DB: flags_db
      POSTGRES_USER: flags_user
      POSTGRES_PASSWORD: flags_password
    volumes:
      - ./flag-service/db/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5434:5432"
    networks:
      - togglemaster

  # -------------------------------------------------------------
  # FLAG-SERVICE
  # -------------------------------------------------------------
  flag-service:
    build: ./flag-service
    container_name: flag-service
    depends_on:
      - flag-postgres
      - auth-service
    environment:
      PORT: "8002"
      DATABASE_URL: "postgresql://flags_user:flags_password@flag-postgres:5432/flags_db"
      AUTH_SERVICE_URL: "http://auth-service:8001"
      API_KEY: "SUA_CHAVE_GERADA_AQUI"
    ports:
      - "8002:8002"
    networks:
      - togglemaster

  # -------------------------------------------------------------
  # TARGETING-SERVICE
  # -------------------------------------------------------------
  targeting-service:
    build: ./targeting-service
    container_name: targeting-service
    depends_on:
      - auth-service
    environment:
      PORT: "8003"
      AUTH_SERVICE_URL: "http://auth-service:8001"
      API_KEY: "SUA_CHAVE_GERADA_AQUI"
    ports:
      - "8003:8003"
    networks:
      - togglemaster

  # -------------------------------------------------------------
  # EVALUATION-SERVICE (envia eventos ao SQS)
  # -------------------------------------------------------------
  evaluation-service:
    build: ./evaluation-service
    container_name: evaluation-service
    depends_on:
      - flag-service
      - targeting-service
      - sqs-local
    environment:
      PORT: "8004"
      FLAG_SERVICE_URL: "http://flag-service:8002"
      TARGETING_SERVICE_URL: "http://targeting-service:8003"
      AWS_SQS_URL: "http://sqs-local:9324/queue/togglemaster-events"
      AWS_REGION: "us-east-1"
      AWS_ACCESS_KEY_ID: "fake" 
      AWS_SECRET_ACCESS_KEY: "fake"
      AWS_SESSION_TOKEN: "fake"
    ports:
      - "8004:8004"
    networks:
      - togglemaster

  # -------------------------------------------------------------
  # SQS LOCALSTACK (ElasticMQ)
  # -------------------------------------------------------------
  sqs-local:
    image: softwaremill/elasticmq-native:latest
    container_name: sqs-local
    ports:
      - "9324:9324" # SQS API
    volumes:
      - ./localstack/elasticmq.conf:/opt/elasticmq.conf
    networks:
      - togglemaster

  # -------------------------------------------------------------
  # DYNAMODB LOCAL
  # -------------------------------------------------------------
  dynamodb-local:
    image: amazon/dynamodb-local
    container_name: dynamodb-local
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath /data"
    volumes:
      - ./dynamodb:/data
    networks:
      - togglemaster

  # -------------------------------------------------------------
  # ANALYTICS-SERVICE (consome SQS e grava no DynamoDB)
  # -------------------------------------------------------------
  analytics-service:
    build: ./analytics-service
    container_name: analytics-service
    depends_on:
      - sqs-local
      - dynamodb-local
    environment:
      PORT: "8006"

      # ---- Endpoints locais ----
      AWS_SQS_URL: "http://sqs-local:9324/queue/togglemaster-events"
      AWS_DYNAMODB_ENDPOINT: "http://dynamodb-local:8000"
      AWS_DYNAMODB_TABLE: "ToggleMasterAnalytics"

      AWS_REGION: "us-east-1"

      # ---- Credenciais falsas ----
      AWS_ACCESS_KEY_ID: "fake"
      AWS_SECRET_ACCESS_KEY: "fake"
      AWS_SESSION_TOKEN: "fake"

    ports:
      - "8006:8006"
    networks:
      - togglemaster

# -------------------------------------------------------------
# REDE COMPARTILHADA
# -------------------------------------------------------------
networks:
  togglemaster:
    driver: bridge
